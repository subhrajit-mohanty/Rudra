name: CI

"on":
  push:
    branches:
      - main
      - master
  pull_request:
    branches:
      - main
      - master

jobs:
  lint:
    name: Lint & Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Poetry
        run: pip install poetry

      - name: Install dependencies
        run: poetry install --no-interaction

      - name: Lint with Ruff
        run: poetry run ruff check backend/ sdk/python/

      - name: Validate Python syntax
        run: |
          python -c "
          import ast, sys, pathlib
          errors = []
          for f in pathlib.Path('backend').glob('*.py'):
              try: ast.parse(f.read_text())
              except SyntaxError as e: errors.append(f'{f}: {e}')
          for f in pathlib.Path('sdk/python').rglob('*.py'):
              try: ast.parse(f.read_text())
              except SyntaxError as e: errors.append(f'{f}: {e}')
          if errors:
              print('\n'.join(errors))
              sys.exit(1)
          print('All Python files valid')
          "

  frontend:
    name: Build Frontend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install dependencies
        working-directory: frontend
        run: npm install

      - name: Build
        working-directory: frontend
        run: npm run build

  docker:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [lint, frontend]
    steps:
      - uses: actions/checkout@v4

      - name: Build backend image
        run: docker build -t rudra-backend ./backend

      - name: Build frontend image
        run: docker build -t rudra-frontend ./frontend

  sdk-python:
    name: Test Python SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install SDK
        run: |
          cd sdk/python
          pip install -e .

      - name: Validate SDK imports
        run: |
          python -c "
          from rudra_sdk import RudraClient, RudraAPIError
          client = RudraClient('http://localhost:8000', token='test')
          assert client.token == 'test'
          assert hasattr(client, 'projects')
          assert hasattr(client, 'users')
          assert hasattr(client, 'organizations')
          assert hasattr(client, 'roles')
          assert hasattr(client, 'sso')
          assert hasattr(client, 'webhooks')
          assert hasattr(client, 'coupons')
          assert hasattr(client, 'analytics')
          print('Python SDK OK - all resources verified')
          "

  sdk-javascript:
    name: Test JavaScript SDK
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Validate SDK
        run: |
          node --input-type=module -e "
          import { RudraClient, RudraAPIError } from './sdk/javascript/src/index.js';
          const client = new RudraClient('http://localhost:8000', { token: 'test' });
          console.assert(client.token === 'test');
          console.assert(client.projects !== undefined);
          console.assert(client.users !== undefined);
          console.assert(client.organizations !== undefined);
          console.assert(client.roles !== undefined);
          console.assert(client.sso !== undefined);
          console.assert(client.webhooks !== undefined);
          console.assert(client.coupons !== undefined);
          console.assert(client.analytics !== undefined);
          console.log('JavaScript SDK OK - all resources verified');
          "
